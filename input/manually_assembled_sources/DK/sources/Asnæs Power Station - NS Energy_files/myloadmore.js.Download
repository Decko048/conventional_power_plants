jQuery(function($){
	var ajaxRequestProject = null;
	var canBeLoaded = true; // this param allows to initiate the AJAX call only if necessary
	     // the distance (in px) from the page bottom when you want to load more posts	
	$(window).scroll(function(){
		if($(window).scrollTop() + $(window).height() > $(document).height() - 250){
			//var posts_not_in= $(".post_not_in").val();
			var posts_not_in=[];
			/* var idsToExclude=JSON.parse($('#lnhome').attr("data-idsExclude"));			
			posts_not_in.push.apply(posts_not_in, idsToExclude); */
			
			$("#lnhome .ajax_row").each(function(){
				var arid=$(this).data('arid');
				if(arid!=''){
					posts_not_in.push(arid);
				}
			});
			var pr_count=$(".pageloader").length;			
			if(pr_count > 0){		
				if(posts_not_in.length>0){
					var data = {
						'action': 'loadmore',
						'query': pmg_loadmore_params.posts,
						'page' : pmg_loadmore_params.current_page,
						'post_not_in':{posts_not_in}
					};
				}
				else{
					var data = {
						'action': 'loadmore',
						'query': pmg_loadmore_params.posts,
						'page' : pmg_loadmore_params.current_page
					};
				}
					console.log(data);	
				if( ajaxRequestProject != null ) {
					ajaxRequestProject.abort();
					ajaxRequestProject = null;
				}			
				ajaxRequestProject = $.ajax({
					url : pmg_loadmore_params.ajaxurl,
					data:data,
					type:'POST',
					success:function(data){
						if(data) {						
							if(data.trim()!=''){
								if($('#lnhome').length == 0){
									$('.pageloader').remove();
									$('#categorypageid').find('li.ajax_row:last-of-type').after('<div class="pageloader"><div class="loader"></div></div>');	
									$('#categorypageid').find('li.ajax_row:last-of-type').after( data );	
								
								}else{							
									$('.pageloader').remove();
									$('#lnhome').find('ul.col-md-12 li.ajax_row:last-of-type').after('<div class="pageloader"><div class="loader"></div></div>');
									$('#lnhome').find('ul.col-md-12 li.ajax_row:last-of-type').after( data ); 
									
								}								
							}else{
								$('.pageloader').remove();
							}
							canBeLoaded = true; // the ajax is completed, now we can run it again
							
							pmg_loadmore_params.current_page++;
						}
					},
					error:function(){					
							$('.pageloader').remove();
					},
			         
				}); 
			}
		}		
	});
	
});